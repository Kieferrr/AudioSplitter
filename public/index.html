<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Audio Splitter</title>

  <!-- Favicon -->
  <link rel="icon" href="imgs/icons8-musical-48.png" type="image/png">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <style>
    /* Estilos para modo oscuro */
    body {
      background-color: #2b2b2b;
      color: #f5f5f5;
    }

    /* Ajusta colores de los inputs y botones en modo oscuro */
    .form-control {
      background-color: #3a3a3a;
      color: #f5f5f5;
      border: 1px solid #555;
    }

    .form-control:focus {
      background-color: #3a3a3a;
      color: #fff;
      border-color: #666;
      box-shadow: none;
    }

    .btn-primary {
      background-color: #5c5cec;
      border-color: #4c4ceb;
    }

    .btn-primary:hover {
      background-color: #4c4ceb;
      border-color: #3c3cdb;
    }

    /* Estilos adicionales para mejorar la apariencia */
    .container {
      max-width: 1000px;
    }

    .form-section {
      margin-bottom: 2rem;
      text-align: left;
    }

    /* Spinner personalizado */
    .spinner-border-custom {
      width: 1.5rem;
      height: 1.5rem;
      border-width: 0.2em;
    }

    /* Estilos para las etiquetas */
    label {
      color: #f5f5f5;
      font-weight: bold;
      margin-bottom: 0.5rem;
      display: block;
      text-align: left;
    }

    /* Ajustar el input de archivo para que coincida con el input de texto */
    input[type="file"] {
      background-color: #3a3a3a;
      color: #f5f5f5;
      border: 1px solid #555;
      padding: 0.375rem 0.75rem;
      border-radius: 0.25rem;
      cursor: pointer;
    }

    input[type="file"]::file-selector-button {
      background-color: #d0d0d4;
      color: #2c2b2b;
      border: none;
      padding: 0.375rem 0.75rem;
      border-radius: 0.25rem;
      cursor: pointer;
      margin-right: 0.5rem;
    }

    input[type="file"]::file-selector-button:hover {
      background-color: #4c4ceb;
    }

    /* Estilos para las tarjetas de audio */
    .audio-card {
      background-color: #2b2b2b;
      border: 1px solid #2b2b2b;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .audio-label {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    /* Estilos para el reproductor maestro */
    .master-player {
      background-color: #3a3a3a;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      position: relative;
    }

    .progress-container {
      position: relative;
      width: 100%;
      height: 10px;
      background-color: #555;
      border-radius: 5px;
      cursor: pointer;
    }

    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background-color: #5c5cec;
      width: 0%;
      border-radius: 5px;
    }

    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    /* Estilos para Wavesurfer.js */
    #waveform {
      width: 100%;
      height: 150px;
      margin-top: 1rem;
      border-radius: 8px;
      overflow: hidden;
      pointer-events: none;
    }

    /* Estilos para los botones de stems */
    .stem-buttons-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .stem-button {
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      font-size: 0.9rem;
      flex: 1 1 auto;
    }

    .stem-button.unmuted {
      background-color: #28a745;
    }

    .stem-button.muted {
      background-color: #6c757d;
    }

    .stem-button:active {
      transform: scale(0.98);
    }

    /* Estilos para el tooltip de la barra de progreso */
    #progressTooltip {
      position: absolute;
      top: -35px;
      left: 0;
      transform: translateX(-50%);
      background-color: #343a40;
      color: #fff;
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      display: none;
      white-space: nowrap;
      pointer-events: none;
      z-index: 10;
    }

    #progressTooltip::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: #343a40 transparent transparent transparent;
    }

    /* Estilos para el mensaje de estado */
    #status {
      text-align: center;
    }

    /* Estilos para el control de volumen */
    #masterVolume {
      cursor: pointer;
    }

    /* Estilos para mantener el ancho fijo del bot√≥n Play/Pause */
    .fixed-width-btn {
      width: 150px;
      text-align: center;
      flex-shrink: 0;
      flex-grow: 0;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <h1 class="mb-4 text-center">Audio Splitter</h1>
    <br>
    <!-- Formulario para URL de YouTube -->
    <div class="form-section">
      <label for="youtubeUrl">Separar con YouTube</label>
      <form id="youtube-form" class="d-inline-block w-100">
        <div class="input-group mb-3">
          <input type="text" id="youtubeUrl" name="youtubeUrl" placeholder="Pega la URL de YouTube" class="form-control"
            required autocomplete="off" />
          <button type="submit" class="btn btn-primary">Procesar</button>
        </div>
      </form>
    </div>

    <!-- Formulario para subir archivos -->
    <div class="form-section">
      <label for="audioFile">Separar archivo</label>
      <form id="upload-form" class="d-inline-block w-100" enctype="multipart/form-data">
        <div class="input-group mb-3">
          <input type="file" id="audioFile" name="audioFile" class="form-control" accept=".mp3, .wav, .mp4" required />
          <button type="submit" class="btn btn-primary">Subir y Procesar</button>
        </div>
      </form>
    </div>

    <!-- Mensaje de estado -->
    <div id="status" class="mt-3"></div>

    <!-- Reproductor Maestro -->
    <div class="master-player d-none" id="masterPlayer">
      <h5>Reproductor Maestro</h5>

      <!-- Contenedor de botones de stems -->
      <div class="stem-buttons-container" id="stemButtonsContainer">
        <!-- Los botones de stems se agregar√°n aqu√≠ -->
      </div>

      <!-- Bot√≥n Play/Pause y Control de Volumen -->
      <div class="d-flex align-items-center mb-2">
        <button id="masterPlayPause" class="btn btn-success me-3 fixed-width-btn">‚ñ∂Ô∏è Reproducir</button>

        <!-- Control de Volumen -->
        <div class="d-flex align-items-center">
          <label for="masterVolume" class="me-2 mb-0">üîä Volumen</label>
          <input type="range" class="form-range" id="masterVolume" min="0" max="1" step="0.01" value="1"
            style="width: 150px;">
        </div>
      </div>

      <!-- Barra de progreso -->
      <div class="progress-container" id="masterProgress">
        <div class="progress-bar" id="masterProgressBar"></div>
        <div id="progressTooltip">00:00</div>
      </div>
      <div class="time-display">
        <span id="currentTime">00:00</span>
        <span id="totalTime">00:00</span>
      </div>

      <!-- Contenedor para Wavesurfer.js -->
      <div id="waveform"></div>
    </div>

    <!-- Spinner (oculto por defecto) -->
    <div id="spinner" class="d-none d-flex align-items-center justify-content-center my-3">
      <strong>Procesando...</strong>
      <div class="spinner-border spinner-border-custom text-primary ms-2" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Contenedor para los resultados -->
    <div id="result" class="mt-4 row g-3">
      <!-- Las tarjetas de audio se agregar√°n aqu√≠ -->
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Howler.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

  <!-- Wavesurfer.js desde jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js"></script>

  <script>
    // --- CONFIGURACI√ìN Y VARIABLES GLOBALES ---

    const stemLabels = {
      'vocals': { label: 'Voz', icon: 'üé§' },
      'drums': { label: 'Bater√≠a', icon: 'ü•Å' },
      'bass': { label: 'Bajo', icon: 'üé∏' },
      'piano': { label: 'Piano', icon: 'üéπ' },
      'other': { label: 'Otros', icon: 'üéµ' }
    };

    const youtubeForm = document.getElementById('youtube-form');
    const uploadForm = document.getElementById('upload-form');
    const statusDiv = document.getElementById('status');
    const spinner = document.getElementById('spinner');
    const resultDiv = document.getElementById('result');
    const masterPlayer = document.getElementById('masterPlayer');
    const masterPlayPauseBtn = document.getElementById('masterPlayPause');
    const masterProgress = document.getElementById('masterProgress');
    const masterProgressBar = document.getElementById('masterProgressBar');
    const currentTimeSpan = document.getElementById('currentTime');
    const totalTimeSpan = document.getElementById('totalTime');
    const waveformContainer = document.getElementById('waveform');
    const progressTooltip = document.getElementById('progressTooltip');
    const masterVolumeSlider = document.getElementById('masterVolume');

    // Objeto para almacenar los Howl de cada stem
    const stemsHowls = {};

    // Variables de estado y tiempo
    let currentPlaybackTime = 0;
    let playStartTimestamp = null;
    let accumulatedTime = 0;
    let updateInterval = null;
    let isPlaying = false;
    let wavesurfer = null;

    // Variable para el Debounce (Evita audio doble)
    let seekTimeout = null;

    // --- FUNCIONES DE LIMPIEZA Y SETUP ---

    function cleanupAudio() {
      if (wavesurfer) {
        wavesurfer.destroy();
        wavesurfer = null;
      }

      for (const stem in stemsHowls) {
        if (stemsHowls.hasOwnProperty(stem)) {
          stemsHowls[stem].stop(); // Stop resetea y limpia buffers
          stemsHowls[stem].unload();
        }
      }
      for (const key in stemsHowls) delete stemsHowls[key];

      const stemButtonsContainer = document.getElementById('stemButtonsContainer');
      if (stemButtonsContainer) stemButtonsContainer.innerHTML = '';

      masterPlayPauseBtn.innerHTML = '‚ñ∂Ô∏è Reproducir';
      isPlaying = false;
      masterProgressBar.style.width = '0%';
      currentTimeSpan.textContent = '00:00';
      totalTimeSpan.textContent = '00:00';

      stopPlaybackTimer();
      masterVolumeSlider.value = 1;
      Howler.volume(1);

      currentPlaybackTime = 0;
      accumulatedTime = 0;
      playStartTimestamp = null;
    }

    function initializeWavesurfer(audioUrl) {
      if (wavesurfer) {
        wavesurfer.destroy();
        wavesurfer = null;
      }

      wavesurfer = WaveSurfer.create({
        container: waveformContainer,
        waveColor: '#5c5cec',
        progressColor: '#28a745',
        cursorColor: '#FFD700',
        height: 150,
        responsive: true,
        normalize: true,
        backend: 'MediaElement',
        interact: false,
        cursorWidth: 0
      });

      wavesurfer.load(audioUrl);

      wavesurfer.on('ready', () => {
        console.log('Wavesurfer listo.');
        totalTimeSpan.textContent = formatTime(wavesurfer.getDuration());
        wavesurfer.pause();
        wavesurfer.setVolume(0);
      });
    }

    // --- L√ìGICA DE SINCRONIZACI√ìN V3 (ESTABLE) ---

    function seekAllStems(targetTime) {
      // 1. LIMPIEZA DE CONFLICTOS (Debounce)
      // Si el usuario hizo clic hace menos de 100ms, cancelamos la orden anterior
      if (seekTimeout) clearTimeout(seekTimeout);

      // 2. PAUSA INMEDIATA (Evita que sigan sonando mientras calculamos)
      stopPlaybackTimer();
      Object.values(stemsHowls).forEach(h => h.pause());

      // 3. ACTUALIZACI√ìN VISUAL INMEDIATA
      currentPlaybackTime = targetTime;
      accumulatedTime = targetTime;
      updateProgressBar(targetTime);

      // 4. EJECUCI√ìN DIFERIDA (Para asegurar estabilidad)
      seekTimeout = setTimeout(() => {

        // Aplicamos el Seek a todos los stems
        Object.values(stemsHowls).forEach(h => {
          h.seek(targetTime);
        });

        // Solo si estaba reproduciendo antes, volvemos a dar Play
        if (isPlaying) {
          playStartTimestamp = Date.now() - currentPlaybackTime * 1000;
          startPlaybackTimer();

          Object.values(stemsHowls).forEach(h => {
            // Solo reproducimos los que tienen volumen (no muteados)
            if (h.volume() > 0) {
              h.play();
            }
          });
        }
      }, 50); // 50ms de espera para asegurar que el motor de audio proces√≥ la pausa
    }


    // --- MANEJO DE RESPUESTA Y CREACI√ìN DE AUDIO ---

    async function handleResponse(data) {
      spinner.classList.add('d-none');
      statusDiv.innerHTML = `<div class="alert alert-success" role="alert"><strong>${data.message}</strong></div>`;

      cleanupAudio();
      masterPlayer.classList.remove('d-none');

      if (data.files.length > 0) {
        initializeWavesurfer(data.files[0]);
      }

      data.files.forEach((fileUrl) => {
        const fileName = fileUrl.split('/').pop();
        const stemName = fileName.split('.')[0].toLowerCase();
        const stemInfo = stemLabels[stemName] || { label: 'Instrumentos', icon: 'üé∂' };

        const stemButton = document.createElement('button');
        stemButton.className = 'stem-button unmuted';
        stemButton.id = `stem-button-${stemName}`;
        stemButton.innerHTML = `${stemInfo.icon} ${stemInfo.label}`;
        document.getElementById('stemButtonsContainer').appendChild(stemButton);

        const howl = new Howl({
          src: [fileUrl],
          html5: true,
          volume: 1,
          preload: true,
          onload: () => {
            if (Object.keys(stemsHowls).length === 1) {
              totalTimeSpan.textContent = formatTime(howl.duration());
            }
          }
        });

        stemsHowls[stemName] = howl;

        stemButton.addEventListener('click', function () {
          const isMuted = howl.volume() === 0;
          if (isMuted) {
            howl.seek(currentPlaybackTime);
            howl.volume(1);
            if (isPlaying && !howl.playing()) {
              howl.play();
            }
            this.classList.remove('muted');
            this.classList.add('unmuted');
          } else {
            howl.volume(0);
            this.classList.remove('unmuted');
            this.classList.add('muted');
          }
        });
      });
    }

    // --- UTILIDADES ---

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateProgressBar(currentTime) {
      if (!wavesurfer) return;
      const duration = wavesurfer.getDuration() || 1;
      // FIX: Asegurar que nunca pase del 100%
      const progressPercent = Math.min((currentTime / duration) * 100, 100);

      masterProgressBar.style.width = `${progressPercent}%`;
      currentTimeSpan.textContent = formatTime(currentTime);

      // FIX: Asegurar que seekTo no reciba m√°s de 1
      wavesurfer.seekTo(Math.min(progressPercent / 100, 1));
    }

    function startPlaybackTimer() {
      if (updateInterval) clearInterval(updateInterval);

      playStartTimestamp = Date.now() - accumulatedTime * 1000;

      updateInterval = setInterval(() => {
        currentPlaybackTime = (Date.now() - playStartTimestamp) / 1000;

        // --- FIX: DETECCI√ìN DE FIN DE CANCI√ìN ---
        const duration = wavesurfer ? wavesurfer.getDuration() : 0;

        if (duration > 0 && currentPlaybackTime >= duration) {
          stopPlaybackTimer();
          isPlaying = false;
          masterPlayPauseBtn.innerHTML = '‚ñ∂Ô∏è Reproducir';

          // Resetear al inicio
          currentPlaybackTime = 0;
          accumulatedTime = 0;
          updateProgressBar(0);

          Object.values(stemsHowls).forEach(h => {
            h.stop(); // Stop es mejor al finalizar para limpiar
            h.seek(0);
          });
          return;
        }
        // ----------------------------------------

        updateProgressBar(currentPlaybackTime);
      }, 100);
    }

    function stopPlaybackTimer() {
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }
      accumulatedTime = currentPlaybackTime;
    }

    function showSpinner() {
      statusDiv.innerHTML = '';
      spinner.classList.remove('d-none');
      resultDiv.innerHTML = '';
      masterPlayer.classList.add('d-none');
      cleanupAudio();
    }

    // --- EVENT LISTENERS UI ---

    youtubeForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showSpinner();
      const youtubeInput = document.getElementById('youtubeUrl');
      const urlValue = youtubeInput.value.trim();
      youtubeInput.value = '';

      try {
        const response = await fetch('/process-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ youtubeUrl: urlValue })
        });
        if (!response.ok) throw new Error(await response.text());
        handleResponse(await response.json());
      } catch (err) {
        spinner.classList.add('d-none');
        statusDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${err.message}</div>`;
      }
    });

    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showSpinner();
      const formData = new FormData(uploadForm);
      try {
        const response = await fetch('/upload-file', { method: 'POST', body: formData });
        if (!response.ok) throw new Error(await response.text());
        handleResponse(await response.json());
        document.getElementById('audioFile').value = '';
      } catch (err) {
        spinner.classList.add('d-none');
        statusDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${err.message}</div>`;
      }
    });

    masterPlayPauseBtn.addEventListener('click', () => {
      if (isPlaying) {
        isPlaying = false;
        stopPlaybackTimer();
        Object.values(stemsHowls).forEach(h => h.pause());
        masterPlayPauseBtn.innerHTML = '‚ñ∂Ô∏è Reproducir';
      } else {
        isPlaying = true;
        startPlaybackTimer();
        Object.values(stemsHowls).forEach(h => {
          if (h.volume() > 0) {
            h.seek(currentPlaybackTime);
            h.play();
          }
        });
        masterPlayPauseBtn.innerHTML = '‚è∏Ô∏è Pausar';
      }
    });

    // --- L√ìGICA DE BARRA DE PROGRESO (CON CLICK) ---
    masterProgress.addEventListener('click', (e) => {
      if (!wavesurfer) return;

      const rect = masterProgress.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const width = rect.width;
      const clickRatio = clickX / width;

      const safeRatio = Math.min(Math.max(clickRatio, 0), 1);
      const newSeekTime = wavesurfer.getDuration() * safeRatio;

      seekAllStems(newSeekTime);
    });

    masterProgress.addEventListener('mousemove', (e) => {
      if (!wavesurfer) return;
      const rect = masterProgress.getBoundingClientRect();
      const offsetX = e.clientX - rect.left;
      const duration = wavesurfer.getDuration();
      const hoverTime = duration * (offsetX / rect.width);

      progressTooltip.style.left = `${offsetX}px`;
      progressTooltip.textContent = formatTime(Math.max(0, hoverTime));
      progressTooltip.style.display = 'block';
    });

    masterProgress.addEventListener('mouseleave', () => {
      progressTooltip.style.display = 'none';
    });

    masterVolumeSlider.addEventListener('input', (e) => {
      Howler.volume(parseFloat(e.target.value));
    });

  </script>

</body>

</html>